# Relay & Fallback Feature - Complete History

**Date:** December 24, 2024  
**Time Spent:** ~10 hours  
**Final Commit:** d9156ad (reverted to working fallback)

---

## Current Working State

| Feature | Status |
|---------|--------|
| Fallback activates when encoder drops | ✅ WORKS |
| Stream plays audio | ✅ WORKS |
| Mixxx can reconnect when fallback active | ❌ NOT WORKING (known limitation) |
| Badge colors | ⚠️ May be reversed (cosmetic) |

**Architecture limitation:** Fallback and encoder reconnect are MUTUALLY EXCLUSIVE with current approach. They both use the same mount point.

---

## Executive Summary

Implemented standard Icecast fallback relay feature. Faced multiple issues due to:
1. Port misconfiguration (8000 vs 8100)
2. FFmpeg protocol issues
3. Startup timing (Icecast starts before config generated)

**UNSOLVED:** Encoder reconnect when fallback is running. The startup.sh fix that would solve this also broke fallback - needs more investigation.

---

## The Full Journey

### Phase 0: Earlier Context (from previous session)

**Docker Disk Space Crisis:**
- Coolify server was at 99% disk usage
- Deployments were failing with `ENOSPC` errors
- Ran `docker system prune -a -f` to clean up
- Reduced to 75% - deployments working again

**UI Additions:**
- Added "Diagnostics" page to sidebar menu (`/diagnostics`)
- Route was already protected by `ProtectedLayout` in App.jsx

---

### Phase 1: Initial Relay Debugging (~2 hours)

**Starting Problem:** Relay feature wasn't working at all. Stream URL wasn't playing audio.

**Bugs Found & Fixed:**

| Bug | Investigation | Fix | Commit |
|-----|---------------|-----|--------|
| Port mismatch | relayManager.js had default 8000, Icecast on 8100 | Changed to 8100 | 230f1e4 |
| Hidden FFmpeg logs | loglevel was 'warning', hid connection messages | Changed to 'info' | 230f1e4 |
| HTTP PUT failed | Tried HTTP PUT method, Icecast returned 400 | Use icecast:// | a4c3aaf |
| Codec copy failed | `-c:a copy` failed on some streams | Use libmp3lame | 230f1e4 |

**Working State Achieved:** 
- User said "Wooo hoo!!!!! finally !!! it works it works!"
- Fallback activates when encoder drops ✅
- Stream URL plays audio ✅

---

### Phase 2: Badge Color Chase (~2 hours)

**New Request:** Make FALLBACK badge green when active, orange when standby.

**What Happened:**
1. Added `station.relayStatus === 'active'` check → colors reversed
2. Tried multiple conditions → confusion about what isLive means
3. Multiple reverts trying to get badge right
4. **Learned:** Badge color is purely cosmetic, doesn't affect functionality

**Commits in this phase:** c47f108, f17a469, a050ebf, 5331fee, 090cb3f, many reverts

**Result:** Badge logic exists but colors may still be incorrect

---

### Phase 3: Encoder Can't Reconnect (~3 hours)

**New Problem:** When fallback relay is streaming, Mixxx can't connect.

**Root Cause Analysis:**
- Icecast only allows ONE source per mount point
- Relay was streaming to main mount `/new`
- Mixxx tried to connect to `/new` → REJECTED

**Attempted Fix #1:** Stream to `-fallback` mount
- Changed relayManager.js to use `${mountPoint}-fallback`
- **Result:** BROKE FALLBACK completely
- Relay couldn't connect to `-fallback` mount

**Why It Broke:**
- Icecast config is generated by Node.js AFTER Icecast starts
- `-fallback` mounts don't exist when Icecast starts
- `reloadconfig` only updates SOME settings, NOT new mounts
- New mounts require full Icecast restart

**Commits:** 38d81eb (broke it), 58958aa (reverted)

---

### Phase 4: The Real Fix (~2 hours)

**Research:** Looked up standard Icecast fallback implementation.

**Standard Pattern:**
```
Main mount:    /new         (encoder streams here)
Fallback mount: /new-fallback (relay streams here, hidden)
Config:         fallback-mount + fallback-override=1
```

**Root Cause Found:**
```
Startup Sequence (BROKEN):
1. Container starts
2. Icecast reads /etc/icecast.xml (OLD config, no -fallback mounts)
3. Node.js starts
4. Node.js generates NEW config with -fallback mounts
5. Calls reloadconfig → doesn't add new mounts!
6. Relay tries to connect to -fallback mount → FAILS
```

**The Fix:**
```
Startup Sequence (FIXED):
1. Container starts
2. startup.sh runs
3. Node.js generates config FIRST
4. THEN Icecast starts with correct config
5. All mounts exist from the start
6. Relay connects to -fallback mount → WORKS
```

---

## Files Changed Today

| File | Lines | Change |
|------|-------|--------|
| `server/relayManager.js` | ~20 | Port 8100, icecast://, libmp3lame, -fallback mount |
| `server/icecastConfig.js` | ~15 | Pre-create all -fallback mounts |
| `Dockerfile` | ~5 | Use startup.sh |
| `startup.sh` | ~25 | NEW: generate config before Icecast |
| `supervisord.conf` | 0 | Unchanged |

---

## Key Code Locations

### server/relayManager.js

**Line 16:** Port MUST be 8100
```javascript
const ICECAST_INTERNAL_PORT = process.env.ICECAST_PORT || 8100;
```

**Line 53:** Fallback streams to -fallback mount
```javascript
const targetMount = station.relay_mode === 'fallback' 
    ? `${mountPoint}-fallback` 
    : mountPoint;
```

### server/icecastConfig.js

**Lines 34-44:** Creates BOTH mounts for every station
```javascript
xml += `<mount>
    <mount-name>${mount}</mount-name>
    <fallback-mount>${mount}-fallback</fallback-mount>
    <fallback-override>1</fallback-override>
</mount>`;

xml += `<mount>
    <mount-name>${mount}-fallback</mount-name>
    <hidden>1</hidden>
</mount>`;
```

### startup.sh

Generates config before starting Icecast:
```bash
node -e "import('./server/icecastConfig.js').then(m => m.regenerateIcecastConfig())"
exec supervisord -c /etc/supervisord.conf
```

### Dockerfile

Uses startup.sh:
```dockerfile
COPY startup.sh /app/startup.sh
RUN chmod +x /app/startup.sh
CMD ["/app/startup.sh"]
```

---

## All Commits Today (Chronological)

| Commit | Time | Description |
|--------|------|-------------|
| 230f1e4 | 14:06 | Port 8100, info loglevel, libmp3lame |
| e9fecbf | 14:10 | Docs: port 8100 warning |
| 498dc75 | 14:13 | Docs: handoff document |
| a4c3aaf | 14:18 | Use icecast:// protocol |
| f910955 | 14:39 | "Wooo hoo it works!" |
| c47f108 | 14:59 | Badge color changes |
| a050ebf | 15:06 | Badge only relayStatus |
| f17a469 | 15:09 | Revert badge |
| 2809739 | 15:11 | Docs update |
| 5331fee | 15:14 | Revert Stations.jsx |
| 228e65a | 15:15 | Docs update |
| 090cb3f | 15:27 | Badge color fix |
| d9cb149 | 15:36 | Revert |
| 1bac13f | 15:36 | Revert revert |
| 38d81eb | 15:43 | -fallback mount (BROKE IT) |
| 58958aa | 16:02 | Revert to main mount |
| a609db5 | 16:03 | Docs: current bug status |
| 7538f6e | 16:12 | Pre-create fallback mounts |
| 257c8f2 | 16:21 | Revert relayManager |
| 59b0fd1 | 16:30 | FINAL: startup.sh fix |

---

## Test Checklist (After Deploy)

- [ ] Mixxx connects to station
- [ ] Enable fallback relay mode
- [ ] Disconnect Mixxx → fallback activates
- [ ] Stream plays audio from fallback
- [ ] **CRITICAL:** Reconnect Mixxx → takes over from fallback
- [ ] Disconnect Mixxx again → fallback resumes

---

## Known Issues/Limitations

1. **Mutual exclusivity:** Fallback working = Mixxx can't connect. Fallback broken = Mixxx CAN connect. They use same mount.
2. **Badge colors:** May still be reversed (cosmetic issue)
3. **No graceful handoff:** When Mixxx takes over, there's a brief gap
4. **The startup.sh fix that would solve this ALSO breaks fallback** - needs more investigation

---

## Rollback Instructions

If this fix doesn't work, revert to commit 257c8f2:
```bash
git revert 59b0fd1
git push
```

This restores fallback to main mount (works, but Mixxx can't reconnect).

---

## What We Learned

1. **Always check port numbers** - 8000 vs 8100 cost hours
2. **Startup order matters** - Icecast must start AFTER config generated
3. **Icecast reloadconfig is limited** - doesn't add new mounts
4. **Standard patterns exist** - should have researched first
5. **Document as you go** - not at the end
6. **Fallback and encoder reconnect are mutually exclusive with current approach** - need different architecture

---

## Failed Attempt: December 24, 2024 ~4:53 PM

**Tried:** Stream to `-fallback` mount + polling checks relay status

**Result:** ❌ Broke fallback completely (again)

**Commits:** 4a2a110 → REVERTED → a95e9bd

**Root cause:** `-fallback` mount not accessible when relay tries to connect

---

## Final Status

| Feature | Status |
|---------|--------|
| Fallback activates | ✅ WORKS |
| Stream plays audio | ✅ WORKS |
| Mixxx reconnect during fallback | ❌ LIMITATION |

**This is an architectural limitation.** Accept it or add manual "Stop Fallback" button.

---

## Failed Attempt #2: December 24, 2024 ~5:02 PM

**Tried:** Dockerfile CMD use startup.sh to generate config before Icecast starts

**Result:** ❌ BROKE SERVER COMPLETELY

**Commits:** 10f1747 → REVERTED → 302862d

**Root cause:** startup.sh failed to execute properly

---

## Final Status: December 24, 2024 5:08 PM

**WORKING:**
- Live streaming ✅
- Fallback activates when encoder drops ✅
- Audio plays from fallback ✅

**KNOWN LIMITATION:**
- Mixxx cannot reconnect while fallback is active ❌

**Workaround:** Stop fallback manually before reconnecting Mixxx

**10+ hours spent today. 2 major fix attempts both failed. This is the working state.**

---

## Next Step: Encoder Reconnect Listener

**Idea (for next session):**

When fallback activates (working now), start a listener that:
1. Periodically PAUSES relay for 3-5 seconds
2. During pause, mount is FREE → encoder can connect
3. If encoder connects → polling detects it → auto-stop relay
4. If no encoder → resume relay

**This is code we control.** No Icecast config changes needed.

**Files to modify:**
- `server/relayManager.js` - add pause/resume logic with timer
- `server/index.js` - polling already detects when mount goes live

**Key insight:** We can't detect encoder TRYING to connect. But we can create a window for it to succeed, then detect if it DID connect.

---

## Alternative: Liquidsoap (Industry Standard) - December 25, 2024

**The other AI is correct.** Liquidsoap is the industry-standard solution for exactly this problem.

### Why Liquidsoap Solves Our Problem

Our current architecture:
```
Mixxx → Icecast ← FFmpeg (fight for same mount)
```

Liquidsoap architecture:
```
Mixxx → Liquidsoap → Icecast (one stream, Liquidsoap manages sources)
          ↑
     FFmpeg/Playlist
```

**Liquidsoap handles:**
- Accepting multiple sources (live + fallback)
- Priority/switching between them
- Silence detection
- Outputs ONE stream to Icecast

**Icecast stays simple** - just serves one stream per mount.

### Is This Possible With Our Setup?

**YES, but requires significant changes:**

| Change | Effort | Risk |
|--------|--------|------|
| Add Liquidsoap to Dockerfile | Medium | Breaking change |
| Configure input.harbor for live | Low | Config only |
| Add fallback playlist/stream | Low | Config only |
| Update encoder port (8001 not 8100) | Low | User docs update |
| Modify relayManager.js | High | May not be needed |
| Update supervisord.conf | Low | Add new process |

### Architecture Change

**Current:**
```
Port 8100: Icecast (encoder connects directly)
Node.js:   FFmpeg relay → Icecast
```

**With Liquidsoap:**
```
Port 8001: Liquidsoap harbor (encoder connects here)
Port 8100: Icecast (Liquidsoap streams to here)
Node.js:   Tells Liquidsoap which source to use (optional)
```

### Minimal Liquidsoap Config

```liquidsoap
# /app/radio.liq

# Live input from encoder
live = input.harbor("live", port=8001)

# Fallback from external stream (our current relay URL)
fallback_stream = input.http("http://fallback-url/stream")

# Priority: live first, fallback if live drops
radio = fallback(track_sensitive=false, [live, fallback_stream])

# Output to Icecast
output.icecast(%mp3,
  host="127.0.0.1",
  port=8100,
  password="streamdock_source",
  mount="/stream",
  radio)
```

### Pros vs Cons

**Pros:**
- Industry standard - battle-tested
- Handles the exact problem we've failed to solve
- Clean separation of concerns
- Future features (autodj, scheduling, transitions)

**Cons:**
- Significant architecture change
- Learning curve for Liquidsoap syntax
- More processes to manage
- May need to update user documentation for new encoder port

### Recommendation

**This IS the correct long-term solution.** Our current FFmpeg-to-Icecast approach is fighting against Icecast's design. Liquidsoap was built specifically for multi-source streaming.

**Implementation path:**
1. Add Liquidsoap to Dockerfile
2. Create basic `radio.liq` config
3. Update supervisord to run Liquidsoap
4. Change encoder documentation to use port 8001
5. Eventually: integrate Node.js control of Liquidsoap via telnet

**Effort estimate:** 4-8 hours if done carefully with documentation.

### Decision Point

| Option | Effort | Reliability |
|--------|--------|-------------|
| Keep current (pause/resume hack) | Low | Fragile |
| Liquidsoap integration | Medium-High | Industry-proven |

**My recommendation:** Liquidsoap. The pause/resume approach is clever but hacky. Liquidsoap is what professionals use.

---

## Liquidsoap Integration Plan Created - December 25, 2024

**Full plan at:** `/Users/paulhenshaw/.gemini/antigravity/brain/054ccaf9-12bd-438a-940e-ee174d1aa306/implementation_plan.md`

### Key Architecture Change

**Before (Current - Broken):**
```
Mixxx → Icecast ← FFmpeg (fight for mount)
```

**After (Liquidsoap):**
```
Mixxx → Liquidsoap → Icecast (one stream)
          ↑
     HTTP fallback
```

### Implementation Phases
1. Add Liquidsoap to Docker
2. Basic live input (harbor on port 8001)
3. Add fallback source
4. Node.js integration
5. Documentation cleanup

### What Stays The Same
- React frontend
- Node.js API
- Database
- Stream URLs for listeners
- Email alerts

### What Changes
- Encoder connects to port 8001 (not 8100)
- Liquidsoap manages source priority
- relayManager.js simplifies or removed
- icecastConfig.js simplifies

### Future Possibilities
- AutoDJ (playlist fallback)
- Scheduled shows
- Crossfades
- Silence detection
- Telnet control from Node.js

---

## Coolify Configuration Notes

**Current Traefik Labels (for stream subdomain):**
```
traefik.http.routers.stream-https.rule=Host(`stream.supersoul.top`)
traefik.http.services.stream-service.loadbalancer.server.port=8100
```

**With Liquidsoap - What Changes:**

| Port | Purpose | Traefik Needed? | Change? |
|------|---------|-----------------|---------|
| 3000 | Web UI/API | Yes (via domain) | No change |
| 8100 | Icecast (listener output) | Yes (stream subdomain) | No change |
| 8001 | Liquidsoap (encoder input) | No (raw TCP) | **NEW - add to Ports Exposes/Mappings** |

**Coolify Changes Needed:**
1. Ports Exposes: `3000,8100` → `3000,8100,8001`
2. Ports Mappings: `8100:8100` → `8100:8100,8001:8001`
3. Traefik labels: **No changes** (stream subdomain stays on 8100)

**Encoder Connection (after Liquidsoap):**
```
Server: icecast.supersoul.top
Port: 8001 (was 8100)
Mount: /live
Password: streamdock_source
```
