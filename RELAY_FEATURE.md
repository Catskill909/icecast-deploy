# Relay & Fallback Feature - Complete History

**Date:** December 24, 2024  
**Time Spent:** ~10 hours  
**Final Commit:** d9156ad (reverted to working fallback)

---

## Current Working State

| Feature | Status |
|---------|--------|
| Fallback activates when encoder drops | ✅ WORKS |
| Stream plays audio | ✅ WORKS |
| Mixxx can reconnect when fallback active | ❌ NOT WORKING (known limitation) |
| Badge colors | ⚠️ May be reversed (cosmetic) |

**Architecture limitation:** Fallback and encoder reconnect are MUTUALLY EXCLUSIVE with current approach. They both use the same mount point.

---

## Executive Summary

Implemented standard Icecast fallback relay feature. Faced multiple issues due to:
1. Port misconfiguration (8000 vs 8100)
2. FFmpeg protocol issues
3. Startup timing (Icecast starts before config generated)

**UNSOLVED:** Encoder reconnect when fallback is running. The startup.sh fix that would solve this also broke fallback - needs more investigation.

---

## The Full Journey

### Phase 0: Earlier Context (from previous session)

**Docker Disk Space Crisis:**
- Coolify server was at 99% disk usage
- Deployments were failing with `ENOSPC` errors
- Ran `docker system prune -a -f` to clean up
- Reduced to 75% - deployments working again

**UI Additions:**
- Added "Diagnostics" page to sidebar menu (`/diagnostics`)
- Route was already protected by `ProtectedLayout` in App.jsx

---

### Phase 1: Initial Relay Debugging (~2 hours)

**Starting Problem:** Relay feature wasn't working at all. Stream URL wasn't playing audio.

**Bugs Found & Fixed:**

| Bug | Investigation | Fix | Commit |
|-----|---------------|-----|--------|
| Port mismatch | relayManager.js had default 8000, Icecast on 8100 | Changed to 8100 | 230f1e4 |
| Hidden FFmpeg logs | loglevel was 'warning', hid connection messages | Changed to 'info' | 230f1e4 |
| HTTP PUT failed | Tried HTTP PUT method, Icecast returned 400 | Use icecast:// | a4c3aaf |
| Codec copy failed | `-c:a copy` failed on some streams | Use libmp3lame | 230f1e4 |

**Working State Achieved:** 
- User said "Wooo hoo!!!!! finally !!! it works it works!"
- Fallback activates when encoder drops ✅
- Stream URL plays audio ✅

---

### Phase 2: Badge Color Chase (~2 hours)

**New Request:** Make FALLBACK badge green when active, orange when standby.

**What Happened:**
1. Added `station.relayStatus === 'active'` check → colors reversed
2. Tried multiple conditions → confusion about what isLive means
3. Multiple reverts trying to get badge right
4. **Learned:** Badge color is purely cosmetic, doesn't affect functionality

**Commits in this phase:** c47f108, f17a469, a050ebf, 5331fee, 090cb3f, many reverts

**Result:** Badge logic exists but colors may still be incorrect

---

### Phase 3: Encoder Can't Reconnect (~3 hours)

**New Problem:** When fallback relay is streaming, Mixxx can't connect.

**Root Cause Analysis:**
- Icecast only allows ONE source per mount point
- Relay was streaming to main mount `/new`
- Mixxx tried to connect to `/new` → REJECTED

**Attempted Fix #1:** Stream to `-fallback` mount
- Changed relayManager.js to use `${mountPoint}-fallback`
- **Result:** BROKE FALLBACK completely
- Relay couldn't connect to `-fallback` mount

**Why It Broke:**
- Icecast config is generated by Node.js AFTER Icecast starts
- `-fallback` mounts don't exist when Icecast starts
- `reloadconfig` only updates SOME settings, NOT new mounts
- New mounts require full Icecast restart

**Commits:** 38d81eb (broke it), 58958aa (reverted)

---

### Phase 4: The Real Fix (~2 hours)

**Research:** Looked up standard Icecast fallback implementation.

**Standard Pattern:**
```
Main mount:    /new         (encoder streams here)
Fallback mount: /new-fallback (relay streams here, hidden)
Config:         fallback-mount + fallback-override=1
```

**Root Cause Found:**
```
Startup Sequence (BROKEN):
1. Container starts
2. Icecast reads /etc/icecast.xml (OLD config, no -fallback mounts)
3. Node.js starts
4. Node.js generates NEW config with -fallback mounts
5. Calls reloadconfig → doesn't add new mounts!
6. Relay tries to connect to -fallback mount → FAILS
```

**The Fix:**
```
Startup Sequence (FIXED):
1. Container starts
2. startup.sh runs
3. Node.js generates config FIRST
4. THEN Icecast starts with correct config
5. All mounts exist from the start
6. Relay connects to -fallback mount → WORKS
```

---

## Files Changed Today

| File | Lines | Change |
|------|-------|--------|
| `server/relayManager.js` | ~20 | Port 8100, icecast://, libmp3lame, -fallback mount |
| `server/icecastConfig.js` | ~15 | Pre-create all -fallback mounts |
| `Dockerfile` | ~5 | Use startup.sh |
| `startup.sh` | ~25 | NEW: generate config before Icecast |
| `supervisord.conf` | 0 | Unchanged |

---

## Key Code Locations

### server/relayManager.js

**Line 16:** Port MUST be 8100
```javascript
const ICECAST_INTERNAL_PORT = process.env.ICECAST_PORT || 8100;
```

**Line 53:** Fallback streams to -fallback mount
```javascript
const targetMount = station.relay_mode === 'fallback' 
    ? `${mountPoint}-fallback` 
    : mountPoint;
```

### server/icecastConfig.js

**Lines 34-44:** Creates BOTH mounts for every station
```javascript
xml += `<mount>
    <mount-name>${mount}</mount-name>
    <fallback-mount>${mount}-fallback</fallback-mount>
    <fallback-override>1</fallback-override>
</mount>`;

xml += `<mount>
    <mount-name>${mount}-fallback</mount-name>
    <hidden>1</hidden>
</mount>`;
```

### startup.sh

Generates config before starting Icecast:
```bash
node -e "import('./server/icecastConfig.js').then(m => m.regenerateIcecastConfig())"
exec supervisord -c /etc/supervisord.conf
```

### Dockerfile

Uses startup.sh:
```dockerfile
COPY startup.sh /app/startup.sh
RUN chmod +x /app/startup.sh
CMD ["/app/startup.sh"]
```

---

## All Commits Today (Chronological)

| Commit | Time | Description |
|--------|------|-------------|
| 230f1e4 | 14:06 | Port 8100, info loglevel, libmp3lame |
| e9fecbf | 14:10 | Docs: port 8100 warning |
| 498dc75 | 14:13 | Docs: handoff document |
| a4c3aaf | 14:18 | Use icecast:// protocol |
| f910955 | 14:39 | "Wooo hoo it works!" |
| c47f108 | 14:59 | Badge color changes |
| a050ebf | 15:06 | Badge only relayStatus |
| f17a469 | 15:09 | Revert badge |
| 2809739 | 15:11 | Docs update |
| 5331fee | 15:14 | Revert Stations.jsx |
| 228e65a | 15:15 | Docs update |
| 090cb3f | 15:27 | Badge color fix |
| d9cb149 | 15:36 | Revert |
| 1bac13f | 15:36 | Revert revert |
| 38d81eb | 15:43 | -fallback mount (BROKE IT) |
| 58958aa | 16:02 | Revert to main mount |
| a609db5 | 16:03 | Docs: current bug status |
| 7538f6e | 16:12 | Pre-create fallback mounts |
| 257c8f2 | 16:21 | Revert relayManager |
| 59b0fd1 | 16:30 | FINAL: startup.sh fix |

---

## Test Checklist (After Deploy)

- [ ] Mixxx connects to station
- [ ] Enable fallback relay mode
- [ ] Disconnect Mixxx → fallback activates
- [ ] Stream plays audio from fallback
- [ ] **CRITICAL:** Reconnect Mixxx → takes over from fallback
- [ ] Disconnect Mixxx again → fallback resumes

---

## Known Issues/Limitations

1. **Mutual exclusivity:** Fallback working = Mixxx can't connect. Fallback broken = Mixxx CAN connect. They use same mount.
2. **Badge colors:** May still be reversed (cosmetic issue)
3. **No graceful handoff:** When Mixxx takes over, there's a brief gap
4. **The startup.sh fix that would solve this ALSO breaks fallback** - needs more investigation

---

## Rollback Instructions

If this fix doesn't work, revert to commit 257c8f2:
```bash
git revert 59b0fd1
git push
```

This restores fallback to main mount (works, but Mixxx can't reconnect).

---

## What We Learned

1. **Always check port numbers** - 8000 vs 8100 cost hours
2. **Startup order matters** - Icecast must start AFTER config generated
3. **Icecast reloadconfig is limited** - doesn't add new mounts
4. **Standard patterns exist** - should have researched first
5. **Document as you go** - not at the end
6. **Fallback and encoder reconnect are mutually exclusive with current approach** - need different architecture

---

## Failed Attempt: December 24, 2024 ~4:53 PM

**Tried:** Stream to `-fallback` mount + polling checks relay status

**Result:** ❌ Broke fallback completely (again)

**Commits:** 4a2a110 → REVERTED → a95e9bd

**Root cause:** `-fallback` mount not accessible when relay tries to connect

---

## Final Status

| Feature | Status |
|---------|--------|
| Fallback activates | ✅ WORKS |
| Stream plays audio | ✅ WORKS |
| Mixxx reconnect during fallback | ❌ LIMITATION |

**This is an architectural limitation.** Accept it or add manual "Stop Fallback" button.

---

## Failed Attempt #2: December 24, 2024 ~5:02 PM

**Tried:** Dockerfile CMD use startup.sh to generate config before Icecast starts

**Result:** ❌ BROKE SERVER COMPLETELY

**Commits:** 10f1747 → REVERTED → 302862d

**Root cause:** startup.sh failed to execute properly

---

## Final Status: December 24, 2024 5:08 PM

**WORKING:**
- Live streaming ✅
- Fallback activates when encoder drops ✅
- Audio plays from fallback ✅

**KNOWN LIMITATION:**
- Mixxx cannot reconnect while fallback is active ❌

**Workaround:** Stop fallback manually before reconnecting Mixxx

**10+ hours spent today. 2 major fix attempts both failed. This is the working state.**
